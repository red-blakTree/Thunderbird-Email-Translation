(()=>{var f=class{from;to;constructor(t){this.from=t.from,this.to=t.to}sendMessages(t){let s={type:t.type,data:t.data,id:t.id||this.getRandomId(),isAsync:!1};globalThis.document.dispatchEvent(new CustomEvent(this.to,{detail:JSON.stringify(s)}))}getRandomId(){return Math.random()*1e17+new Date().getTime()}sendAsyncMessages({type:t,data:s}){return new Promise(e=>{let r=this.handleMessages(c=>{c.id===o&&(e(c.data),r())}),o=this.getRandomId(),a={type:t,data:s,id:o,isAsync:!0};globalThis.document.dispatchEvent(new CustomEvent(this.to,{detail:JSON.stringify(a)}))})}handleMessageOnce(t){return new Promise(s=>{let e=this.handleMessage(t,r=>{s(r.data),e()})})}handleMessage(t,s){return this.handleMessages(e=>{e.type===t&&s(e)})}handleMessages(t){let s=e=>{let o=JSON.parse(e.detail||"{}");o&&typeof o=="object"&&t(o)};return globalThis.document.addEventListener(this.from,s),()=>{globalThis.document.removeEventListener(this.from,s)}}},M={get(n,t,s){return t in n?(...e)=>{let r=n[t];return typeof r=="function"?r.apply(n,e):Reflect.get(n,t,s)}:e=>n.sendAsyncMessages({type:t,data:e})}};var x="imt-subtitle-event-to-content-script",w="imt-subtitle-event-to-inject",I=new f({from:x,to:w}),d=new f({from:w,to:x}),q=new Proxy(d,M),C=new Proxy(I,M);function h(n){if(!n)return null;try{let t=n;return n.startsWith("//")?t=globalThis.location.protocol+n:n.startsWith("/")?t=`${globalThis.location.protocol}//${globalThis.location.host}${n}`:n.startsWith("http")||(t=`${globalThis.location.protocol}//${n}`),new URL(t).toString()}catch(t){return console.error(t),n}}var i=class{content=q;config;constructor(t){this.config=t,d.handleMessages(async({type:s,id:e,data:r})=>{let o=this[s];if(!o)return;let a=o.apply(this,[r]);a instanceof Promise&&(a=await a),d.sendMessages({id:e,data:a})})}triggerSubtitle(t){}async translateSubtitle(t){let s=await this.content.requestSubtitle({url:h(t._url)});if(s){if(this.config.responseType=="document"){let r=new DOMParser().parseFromString(s,"text/xml");Object.defineProperty(t,"responseXML",{value:r,writable:!1}),Object.defineProperty(t,"response",{value:r,writable:!1});return}let e=s;(t.responseType=="arraybuffer"||this.config.responseType=="arraybuffer")&&typeof s=="string"&&(e=new TextEncoder().encode(s).buffer),Object.defineProperty(t,"responseText",{value:e,writable:!1}),Object.defineProperty(t,"response",{value:e,writable:!1})}}async translateSubtitleWithResponse(t,s){return await this.content.requestSubtitle({url:h(t),responseText:s})}startRequestSubtitle(t){this.content.startRequestSubtitle({url:h(t)})}async isOnlyResponse(){return this.config.hookType.includes("xhr_response")}async translateSubtitleWithFetch(t,s){let e={...s},r;return typeof t=="string"?r={url:t,method:"GET",headers:{}}:r=await O(t),e?.body&&(e.body=T(e.body)),this.content.requestSubtitle({fetchInfo:JSON.stringify({input:r,options:e})})}async getVideoMeta(t){}isSubtitleRequest(t){return!this.config||!this.config.subtitleUrlRegExp||!t?!1:new RegExp(this.config.subtitleUrlRegExp).test(t||"")}};function O(n){if(n instanceof URL)return{url:n.href,method:"GET",headers:{}};let t=n.clone(),s={url:n.url,method:n.method,headers:Object.fromEntries(n.headers.entries())};if(t.body){let e=T(t.body);if(t.body!==e)return t.text().then(r=>(s.body=r,s));s.body=e}return Promise.resolve(s)}function T(n){if(!n)return n;if(n instanceof FormData||n instanceof URLSearchParams){let t={};for(let[s,e]of n.entries())t[s]=e;return t._formatBodyType="FormData",t}return n}var m=class extends i{timer=null;triggerSubtitle({force:t}){setTimeout(()=>{if(this.config?.subtitleButtonSelector){let s=document.querySelector(this.config.subtitleButtonSelector);if(s){let e=s.getAttribute("aria-pressed")==="true";e&&t?(s.click(),setTimeout(()=>{s.click()},100)):e||s.click();return}}if(this.config?.videoPlayerSelector){let s=document.querySelector(this.config.videoPlayerSelector);s?.toggleSubtitles(),setTimeout(()=>{s?.toggleSubtitles()},100)}},1e3)}async getVideoMeta(){if(!this.config.videoPlayerSelector)return null;try{return await this.sleep(100),document.querySelector(this.config.videoPlayerSelector)?.getPlayerResponse()}catch{return null}}async isOnlyResponse(){let t=await super.isOnlyResponse();return!t||(await this.getVideoMeta())?.videoDetails?.isLive?!1:t}getCurrentTime(){try{return this.config.videoPlayerSelector?document.querySelector(this.config.videoPlayerSelector)?.getCurrentTime():null}catch{return null}}sleep(t){return new Promise(s=>{setTimeout(()=>{s(null)},t)})}};var y=class extends i{timer=null;videoMeta={};lastVideoMeta=null;constructor(t){super(t),this.hookJSON()}hookJSON(){let t=JSON.parse;JSON.parse=s=>{let e=t(s);try{e&&e.result&&e.result.timedtexttracks&&e.result.movieId&&(this.videoMeta[e.result.movieId]=e.result,this.lastVideoMeta=e.result)}catch(r){console.log(r)}return e}}getVideoMeta(t){return this.lastVideoMeta}};var p=class extends i{timer=null;videoMeta={};constructor(t){super(t),this.hookJSON()}hookJSON(){let t=JSON.parse;JSON.parse=s=>{let e=t(s);try{e?.asset?.captions?.length?this.videoMeta[e.id]=e?.asset:e?.previews&&e?.course&&e?.previews?.forEach(r=>{this.videoMeta[r.id]=r})}catch(r){console.error(r)}return e}}getVideoMeta(t){return this.videoMeta[t]}};var g=class extends i{timer=null;videoMeta={};constructor(t){super(t),this.hookJSON()}hookJSON(){let t=JSON.parse;JSON.parse=s=>{let e=t(s);try{if(e?.stream?.sources?.length&&e?.stream?.sources[0]?.complete?.url){let r=window.location.pathname.split("/");r.length>2&&r[r.length-2]==="video"&&(this.videoMeta[r[r.length-1]]=e.stream.sources[0].complete.url)}}catch(r){console.error(r)}return e}}getVideoMeta(t){return this.videoMeta[t]}};var b=class extends i{constructor(t){super(t)}async translateSubtitleWithFetch(t,s){this.main(t,s)}async main(t,s){let e=globalThis.__originalFetch;if(!e)return;let r=t;t instanceof Request&&(r=t.clone());let o=await e(r,s);if(!o.ok)return;let a=await o.json();a.transcripts_urls&&this.requestSubtitle(a.transcripts_urls)}async requestSubtitle(t){await u(),await this.content.requestSubtitle(t)}};var S=class extends i{constructor(t){super(t)}lang="";async translateSubtitleWithFetch(t,s){this.main(t,s)}async main(t,s){let e=globalThis.__originalFetch;if(!e)return;let r=this.getUrl(t);return/textstream_/.test(r)?this.parseLang(r):this.parseAllSubs(t,s,e)}getUrl(t){return t.toString()}async parseLang(t){let e=t.match(/textstream_(\w+)=/)?.[1];return!e||e==this.lang||(this.lang=e,await u(),this.content.changeLang(e)),null}async parseAllSubs(t,s,e){if(!e)return;let r=t;t instanceof Request&&(r=t.clone());let o=await e(r,s);if(!o.ok)return;let a=await o.json();a.text_track_urls&&this.requestSubtitle(a.text_track_urls)}async requestSubtitle(t){await u(),await this.content.requestSubtitle(t)}};var P={hookRequest:()=>{}};async function L(){let n=await d.sendAsyncMessages({type:"getConfig"});if(!n)return;let s={youtube:m,netflix:y,webvtt:i,khanacademy:i,udemy:p,general:i,ebutt:i,hulu:b,mubi:S,disneyplus:g,"fmp4.xml":i,multi_attach_vtt:i,twitter:i,subsrt:i,xml:i,text_track_dynamic:i,av:i}[n.type||""];if(!s)return;let e=new s(n);P.hookRequest(e,n)}P.hookRequest=(n,t)=>{if(t.hookType.includes("xhr")){let s=XMLHttpRequest.prototype.open,e=XMLHttpRequest.prototype.send,r=function(){return this._url=arguments[1],s.apply(this,arguments)},o=async function(){let a=this._url,c=n.isSubtitleRequest(a);return!a||!c?e.apply(this,arguments):(await u(),await n.isOnlyResponse()?(n.startRequestSubtitle(a),this.onreadystatechange=()=>{let R=XMLHttpRequest.DONE;typeof R>"u"&&(R=4),this.readyState===R&&this.status===200&&n.translateSubtitleWithResponse(a,this.responseText)}):await n.translateSubtitle(this),e.apply(this,arguments))};Object.defineProperty(XMLHttpRequest.prototype,"open",{value:r,writable:!0}),Object.defineProperty(XMLHttpRequest.prototype,"send",{value:o,writable:!0})}if(t.hookType.includes("fetch")){let s=globalThis.fetch;globalThis.__originalFetch=s,globalThis.fetch=async function(e,r){let o=typeof e=="string"?e:e.url||e.href;if(!n.isSubtitleRequest(o))return s(e,r);await u();let c=await n.translateSubtitleWithFetch(e,r);return c?new Response(c):s(e,r)}}};var v=!1;async function u(){return v||(await d.handleMessageOnce("contentReady"),v=!0),v}u();L();})();
